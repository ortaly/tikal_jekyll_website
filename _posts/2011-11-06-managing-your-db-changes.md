---
layout: post
title: Managing Your DB Changes
created: 1320579539
author: yanai
permalink: /managing-your-db-changes
tags:
- JAVA
- DB Migration Change management
---
<p>It probably happened to you as well... You develop a product, and after you successfully install it at your customers sites, you end up with dozens of versions/revisions of your product. Each revision has its specific SW, with appropriate DB schema, filled with your product initial data (here again, different for each revision) and customer data. How do you manage this DB changes ? What happen when you have dozens of customers with dozens of deployment revisions ? How to support more than one DB ?</p>
<p>These are some of the questions I had to answer on one of Tikal existing customers projects I'm involved with. The questions above are just example for the issues you have to deal when it comes to DB change management.</p>
<p style="margin-bottom: 0cm; text-decoration: none; ">&nbsp;</p>
<h1><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none">The Problem</span></font></font></font></h1>
<p style="margin-bottom: 0cm"><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none">As said, the the product should be deployed, on dozens of customers sites, and in addition it will be deployed on various testing and sales persons environments.  By the time, different customers and testers will have different versions of the product. At some point, they may want or need to upgrade their existing product version to a newer revision. This upgrade process, should keep the existing data of the customer, while enabling the administrator to upgrade the product to the new revision. As part of this upgrade process, there is a need to upgrade the database schema (executing </span></font></font></font><font color="#0000ff"><font face="Arial, sans-serif"><font size="2"><span lang="zxx"><u><a class="western" href="http://en.wikipedia.org/wiki/Data_Definition_Language"><font face="Times New Roman, serif"><font size="3">DDL</font></font></a></u></span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none"> SQL statements) and the data stored within it (executing </span></font></font></font><font color="#0000ff"><font face="Arial, sans-serif"><font size="2"><span lang="zxx"><u><a class="western" href="http://en.wikipedia.org/wiki/Data_Manipulation_Language"><font face="Times New Roman, serif"><font size="3">DML</font></font></a></u></span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none"> SQL statements). We may even need to apply some Java code to manipulate existing data, for example in case we may need </span></font></font></font><font color="#0000ff"><font face="Arial, sans-serif"><font size="2"><span lang="zxx"><u><a class="western" href="http://en.wikipedia.org/wiki/Binary_large_object"><font face="Times New Roman, serif"><font size="3">BLOB</font></font></a></u></span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none"> migration. These updates depends of course on the customer/tester existing database schema and data. Nevertheless, when this upgrade process is been finished the database should have the appropriate schema and data according to the upgraded product revision. We also need to support failed resuming of failed migrations , due to some errors or network failure while the migration was running).</span></font></font></font></p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p><strong> </strong></p>
<h1><strong><font face="Times New Roman, serif"><font size="3"><font color="#00000a"><span style="text-decoration: none">DB Change Management Tools</span></font></font></font></strong></h1>
<p><strong> </strong></p>
<p>&nbsp;</p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">Rather than &ldquo;inventing the wheel&rdquo; as a solution for the problem, I chose to take one of the existing &ldquo;DB migrations tool&rdquo;, integrate it into the product, and adapt it to our needs. The tool should apply the DB migration on the product startup. This means that when the product will have finally been finished to load, the DB migration tool will have been finished successfully as well (in case of failure, the product will fail to load), keeping all the migration metadata in its own dedicated table/s.</font></font></font></p>
<p style="text-decoration: none; ">&nbsp;</p>
<h2 class="western" style="font-weight: normal; text-decoration: none">&nbsp;</h2>
<p><strong> </strong></p>
<h1><strong><font color="#00000a"><font face="Times New Roman, serif"><font size="3">Choosing The Right Tool</font></font></font></strong></h1>
<p><strong> </strong></p>
<p>&nbsp;</p>
<p><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none">There are quite a few tools for DB migrations - </span></font></font></font><font color="#0000ff"><font face="Arial, sans-serif"><font size="2"><span lang="zxx"><u><a class="western" href="http://code.google.com/p/flyway/"><font face="Times New Roman, serif"><font size="3">Here is a link</font></font></a></u></span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none"> that compares their features. At the end f the day we ended with two choices: </span></font></font></font><font color="#0000ff"><font face="Arial, sans-serif"><font size="2"><span lang="zxx"><u><a class="western" href="http://www.liquibase.org/"><font face="Times New Roman, serif"><font size="3">Liquibase</font></font></a></u></span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none"> and </span></font></font></font><font color="#0000ff"><font face="Arial, sans-serif"><font size="2"><span lang="zxx"><u><a class="western" href="http://code.google.com/p/flyway/"><font face="Times New Roman, serif"><font size="3">Flyway</font></font></a></u></span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none">. Liquibase is more general purpose in the sense that the migration statements are embedded general &ldquo;ChangeSet&rdquo; XML tags in XML files. Liquibase is responsible to translate the &ldquo;ChangeSet&rdquo; instructions in the XML files to DB specific SQL statements. Liquibase has yet another advantage - Each and every &ldquo;ChangeSet&rdquo; statement is been executed as a separate transaction, reflected  in a separated row in Liquibase metadata table, which can help in case the underlying DB does NOT support DDL transactions.</span></font></font></font></p>
<p><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none">Nevertheless, I chose </span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><u>NOT</u></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none"> to use Liquibase , and to take a new tool called <a class="western" href="http://code.google.com/p/flyway/">Flyway</a> instead. There were a few reasons for this decision: First, our chosen RDBMS is PostgreSQL, <a class="western" href="http://wiki.postgresql.org/wiki/Transactional_DDL_in_PostgreSQL:_A_Competitive_Analysis">which does support DDL transactions</a> - The whole file migration can be executed as one transaction (making this Liquibase advantage redundant here). Second, Liquibase does NOT support <a class="western" href="http://en.wikipedia.org/wiki/Binary_large_object">BLOB</a> migrations, or any advanced Java code migrations. We may need to migrate our existing BLOBS data and tables , and we may have complected code that will be easier to write with Java than SQL script. Third, we also have some of the data deployed in yet another NoSQL DB (<a class="western" href="http://www.mongodb.org/">MongoDB</a>), and its data will probably have to be migrated as well as part of the upgrade, and it will be easier to use the same tool for that.</span></font></font></font></p>
<h2 class="western" style="font-weight: normal; text-decoration: none"><font color="#00000a"><font face="Times New Roman, serif"><font size="3">Technical Details</font></font></font></h2>
<p><font face="Times New Roman, serif"><font size="3"><font color="#00000a"><span style="text-decoration: none">As mentioned we chose to take Flyway as our migration tool. There is a special Spring bean in the configuration file, that is responsible to run the migration on Spring application startup (using Spring &ldquo;init-method&rdquo;), before initializing the Hibernate Session Factory, using &ldquo;depends&rdquo; keyword on the Hibernate Session Factory bean. This enables Hibernate's SessionFactory to connect </span></font><font color="#00000a"><u><b>after</b></u></font><font color="#00000a"><span style="text-decoration: none"> the migration had been applied, to the migrated DB, and &ldquo;validate&rdquo; the migrated schema against the current Hibernate configuration.</span></font></font></font></p>
<p><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none">The easiest way to understand how flyway works, is to </span></font></font></font><font color="#0000ff"><font face="Arial, sans-serif"><font size="2"><span lang="zxx"><u><a class="western" href="http://code.google.com/p/flyway/wiki/HowDoesFlywayWork"><font face="Times New Roman, serif"><font size="3">read this page</font></font></a></u></span></font></font></font><font color="#00000a"><font face="Times New Roman, serif"><font size="3"><span style="text-decoration: none">. In our product I have a Maven project for the migrations, and a dedicated base directory to put all the migrations files. Each migration file will have the following file name convention:</span></font></font></font></p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">V&lt;VERSION&gt;_&lt;SEQ&gt;__&lt;Description&gt;.sql</font></font></font></p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">So for example the initial file can be as follow : </font></font></font></p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">V8.0.2.1_A__InitialVersion.sql</font></font></font></p>
<p><font color="#00000a"><font face="Times New Roman, serif"><font size="3">The file above is SQL migration file for the product in version 8.0.2.1 and have a sequence number &ldquo;A&rdquo;. Here are the details for the fields place holder:</font></font></font></p>
<p><font face="Times New Roman, serif"><font size="3"><font color="#00000a"><u><b>VERSION</b></u></font><font color="#00000a"><span style="text-decoration: none"> &ndash; this is the product version, following the internal version product's convention. It usually contains 4 octets with &ldquo;.&rdquo; as a separator between them.</span></font></font></font></p>
<p><font face="Times New Roman, serif"><font size="3"><font color="#00000a"><u><b>SEQ</b></u></font><font color="#00000a"><span style="text-decoration: none"> &ndash; The sequence number/letter this file will be executed on behalf of the product version migration. Thus, the file V8.0.2.1_A__Desc.sql will run just before  V8.0.2.1_B__Desc.sql file. However both files will run after running files from previous product versions &ndash; i.e file V8.0.2.0_B__Desc.sql will run before both files, since it belongs to a previous product version.</span></font></font></font></p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">In practice, Flyway will run all migrations files with higher versions than the existing DB state (reflected in Flyway table), according to the version and sequence number. In case of failure while the migration is running, Flyway will roll back all changes of the current migration file, and will mark this migration step as failed. This will enable resuming and running the migration again, that will start from the last failed point.</font></font></font></p>
<p style="text-decoration: none; ">&nbsp;</p>
<h1><font color="#00000a"><font face="Times New Roman, serif"><font size="3">DB Migration with Java</font></font></font></h1>
<p><font face="Times New Roman, serif"><font size="3"><font color="#00000a"><span style="text-decoration: none">As mentioned, Flyway also enables Java based migrations. All Java migration classes for the product have a dedicated package &ldquo;</span></font><font color="#000000"><span style="text-decoration: none">com.customername.productname.server.persistence.jpa.infra.flyway.postgresql</span></font><font color="#00000a"><span style="text-decoration: none">&rdquo;, and should be located in migration project. </span></font></font></font></p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">The execution of the migration Java files is been integrated with the versioning and sequence of the SQL files , explained in previous section: The naming convention for Java files is similar to the SQL files: </font></font></font></p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">V&lt;VERSION&gt;_&lt;SEQ&gt;__&lt;Description&gt;.java</font></font></font></p>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">The only difference is, this time the VERRSION placeholder can NOT have &ldquo;.&rdquo; separator field between the octets (due to Java files naming), and instead will have &ldquo;_&rdquo; as the separator. So the Java file <font color="#000000">V8_0_2_1_B__InitialVersion</font>.java will run just after V8.0.2.1_A__InitialVersion.sql file execution. In case 2 migrations files (either Java or SQL file) will have an identical VERSION and the same sequence number, an in error will be omitted and the migration will NOT be applied.</font></font></font></p>
<p style="text-decoration: none; ">&nbsp;</p>
<h1><font color="#00000a"><font face="Times New Roman, serif"><font size="3">Summary</font></font></font></h1>
<p style="text-decoration: none; "><font color="#00000a"><font face="Times New Roman, serif"><font size="3">When it comes to DB migration , and DB change management, there are various tools, and its better to adapt one of them to your needs, rather than build your own solution here. These tools have different characteristics, and its better to check your exact needs and constraints before choosing the tool. You can even integrate the tool (at least some of them), as part of your application startup, so it will be easier and somewhat transparent migration.</font></font></font></p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p>&nbsp;</p>
