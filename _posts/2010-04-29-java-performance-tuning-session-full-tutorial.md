---
layout: post
title: 'java performance tuning session: full tutorial'
created: 1272520147
permalink: java-performance-tuning-session-full-tutorial
tags:
- JAVA
- XSS
- threads
- Tenured space
- permgen
- OutOfMemoryError
- Memory
- jvm
- Java heap
- Eden space
---
<p>&nbsp;</p>
<p><span style="color: rgb(0, 0, 0);">This post is a summary of the Java performance tuning session given at on April 27</span><span style="font-size: 6.9pt; color: rgb(0, 0, 0);"><sup>th </sup></span><span style="color: rgb(0, 0, 0);">2010. </span></p>
<p style="margin-right: 0px; line-height: 30px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Maybe we should start with the basic fact the when allocation memory for the JVM and in order to avoid OutOfMemoryError you should take int</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">o  </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">consideration that the total size of the memory allocated is composed of</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">:  </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">1-The heap (controlled by the Xms and Xmx parameters</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">)  </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">2-The permanent generation (controlled by the &ndash;XX:MaxPermSize parameter</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">)  </span></p>
<p style="margin-right: 33px; line-height: 27px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">3-The memory allotted for each thread (controlled by the &ndash;Xss parameter)</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">.  </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Of course, more memory is allocated in case you are using JNI and memory is also allocated for th</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">e  </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">native threads on the specific OS you are running your JVM on</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">.  </span></p>
<p style="margin-bottom: 41px; margin-right: 0px; line-height: 27px;"><span style="color: rgb(0, 0, 0);">The important point being total memory= Heap+ PermGen + xss * (number of threads). </span></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 27px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Methodology to find the causes of a memory and thread leaks: </span></p>
<p style="margin-bottom: 13px; margin-right: 9px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">1-Once a suspicion arises with respect to a memory leak either on the heap, the permanent generation or on the stack, you should generate a memory heap dump and a thread dump. </span></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="color: rgb(0, 0, 0);">Memory dumps: </span></p>
<p style="margin-bottom: 13px; margin-right: 9px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Option 1-The JVM should be configured with the following JVM argumentXX:+HeapDumpOnOutOfMemoryError which will trigger a heap dump on the event of an out of memory error. </span></p>
<p style="margin-bottom: 13px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Option 2-On the command line (\java1.6\bin\) invoke jps ( </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">http://java.sun.com/j2se/1.5.0/docs/tooldocs/share/jps.html </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">) to get the PID of the java process you intend monitoring: </span></p>
<p style="margin-bottom: 23px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Jps &ndash;l </span></p>
<p><img width="531" height="84" src="/files/upload/15/perf_tun_img_0.jpg" alt="" /></p>
<p style="text-align: justify; margin-bottom: 13px; margin-right: 0px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Once you have the PID (3272) use it to generate a Heap dump. On the command line (\java1.6\bin\) invoke jmap (</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">http://java.sun.com/j2se/1.5.0/docs/tooldocs/share/jmap.html</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">): </span></p>
<p style="text-align: justify; margin-bottom: 0px; margin-right: 0px;"><span style="font-family: 'monospace','Courier',monospace; font-size: 9.9pt; color: rgb(0, 0, 0);">jmap -heap:format=b &lt;pid</span><span style="font-family: 'monospace','Courier',monospace; font-size: 9.9pt; color: rgb(0, 0, 0);">&gt;  </span></p>
<p><img width="514" height="47" src="/files/upload/15/perf_tun_img_1.jpg" alt="" /></p>
<p style="text-align: justify; margin-bottom: 13px; margin-right: 11px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Note: generating a full class histogram and a heap dump can last a substantial amount of time, for the duration of which the execution of code running inside the JVM is delayed. </span></p>
<p style="text-align: justify; margin-bottom: 23px; margin-right: 0px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Option 3-using VisualVM (</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">https://visualvm.dev.java.net/</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">) attach to the JVM process and click the &ldquo;Heap dump&rdquo; button to generate a heap dump on the fly: </span></p>
<p><img width="702" height="185" src="/files/upload/15/perf_tun_img_2.jpg" alt="" /></p>
<p>&nbsp;</p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="color: rgb(0, 0, 0);">Thread dumps: </span></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Option a: once you have the PID of the process (see above using jps), you can use jstack (</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">http://java.sun.com/j2se/1.5.0/docs/tooldocs/share/jstack.html</span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">) to generate a thread dump: </span></p>
<p style="margin-bottom: 23px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">jstack [-l] &lt;pid&gt; </span></p>
<p><img width="637" height="43" src="/files/upload/15/perf_tun_img_3.jpg" alt="" /></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Note that I &ldquo;piped&rdquo; the result into a file for postmortem analysis. Also note that in case of a deadlock the following text will be printed out: &ldquo;Found &lt;n&gt; Java-level deadlock: &ldquo; where &lt;n&gt; is the number of deadlock detected. </span></p>
<p style="margin-bottom: 47px; margin-right: 9px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Option b: using VisualVM (see below) attach to the JVM process and click the &ldquo;Thread dump&rdquo; button to generate a thread dump on the fly: </span></p>
<p style="margin-bottom: 47px; margin-right: 9px; line-height: 21px;"><img width="475" height="265" src="/files/upload/15/perf_tun_img_4.jpg" alt="" /></p>
<p style="margin-bottom: 47px; margin-right: 9px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">2-Now that we have a thread and a memory dump we can analyze them offline. We shall see that later. Now let&rsquo;s see how we can monitor the JVM in real time. One tool that was already mentioned in VisualVM. It now ships as part of JDK 1.6 and can be invoked from the JDK&rsquo;s bin directory. The second tool is jstat (<span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">http://java.sun.com/j2se/1.5.0/docs/tooldocs/share/jstat.html</span>). </span></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="color: rgb(0, 0, 0);">Using jstat: </span></p>
<p style="margin-bottom: 13px; margin-right: 9px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Jstat is an excellent command line tool for getting the summary of garbage collection statistics and for detecting issues such as </span><span style="color: rgb(0, 0, 0);">wrong ratio </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">between the &ldquo;Eden&rdquo; and &ldquo;Tenured&rdquo; sections of the JVM heap memory. (see </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">http://www.coderfriendly.com/wp-content/uploads/2009/06/javagc.png </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">for a memory map layout). It can be invoked as follows: </span></p>
<p style="margin-bottom: 23px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">jstat -gcutil -t &lt;pid&gt; 1s 30 </span></p>
<p><img width="740" height="251" src="/files/upload/15/perf_tun_img_5.jpg" alt="" /></p>
<p>&nbsp;</p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">To get a better understanding of what is being printed out I suggest you read the documentation. Usually you would trace down the changes through, for instance, the S0 memory section (or any other </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">section for that matter) and if you see unusual behavior (such as too frequent GC) then you can change the JVM settings and re-test. </span></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="color: rgb(0, 0, 0);">Using VisualVM: </span></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">VisualVM&rsquo;s UI has several different tabs for watching in real-time several JVM parameters. For instance, there is the &ldquo;Monitor&rdquo; tab which provides an insight to the size of the Heap and PermGen sizes, likewise there is the &ldquo;Threads&rdquo; tab which can be utilized to inspect each and every thread running under the JVM. The last tab is the &ldquo;Profiler&rdquo; tab used to profile CPU and memory in real-time. I would use a commercial tool for that (e.g. profiling) such as YourKit or Jprofiler rather than using VisaulVM for real-time profiling since the aforementioned tools can provide more detailed information with respect to Java methods CPU consumption. </span></p>
<p style="margin-bottom: 23px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">3-Analysing thread dumps: a very useful tool for thread dump analysis is no other the TDA (thread dump analyzer </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">http://www.ohloh.net/p/tda </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">) . Once you have a thread dump ready, you can invoke it for offline analysis: </span></p>
<p><img width="740" height="357" src="/files/upload/15/perf_tun_img_6.jpg" alt="" /></p>
<p>&nbsp;</p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">4-Performing heap dump analysis. The best open source tool for heap dump analysis is no other than MAT (memory analysis tool). One you install and invoke it you can open a heap dump (see a complete example here (A Leaking Class Loader demo </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 255); text-decoration: underline;">http://dev.eclipse.org/blogs/memoryanalyzer/2008/05/17/the-unknown-generation-perm/ </span><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">). </span></p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">I will provide two examples of real heap dumps which will provide an insight into the types of memory links that you are likely to encounter. </span></p>
<p style="margin-bottom: 0px; margin-right: 0px; line-height: 21px;"><span style="color: rgb(0, 0, 0);">Example one: </span></p>
<p><img width="791" height="435" src="/files/upload/15/perf_tun_img_7.jpg" alt="" /></p>
<p>&nbsp;</p>
<p style="margin-bottom: 13px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">On a production server the JVM crashed and generated a Heap dump. VisualVM was quick to detect the largest objects and it was easy to see that &ldquo;a&rdquo; and&rdquo;b&rdquo; objects are very large. What was puzzling was, how come we have such a large object in the JVM? And how come two objects seem very very similar in size. </span></p>
<p style="margin-bottom: 23px; margin-right: 0px; line-height: 21px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">Further analysis revealed that the cause of the leak was a StringBuilder was grew and grew over a period of 3 months until it reached 565MB, so this answers the first question, it was a programmer who erroneously appended strings to the StringBuilder: </span></p>
<p><img width="855" height="345" src="/files/upload/15/perf_tun_img_8.jpg" alt="" /></p>
<p>&nbsp;</p>
<p style="text-align: justify; margin-bottom: 0px; margin-right: 0px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">The second issue was: why are there two objects of almost the exact same size? Again the answer was a programmer who erroneously held to object twice cloned. </span></p>
<p style="margin-bottom: 23px; margin-right: 0px;"><span style="color: rgb(0, 0, 0);">Example two</span><span style="color: rgb(0, 0, 0);">:  </span></p>
<p><img width="799" height="350" src="/files/upload/15/perf_tun_img_9.jpg" alt="" /></p>
<p>&nbsp;</p>
<p style="text-align: justify; margin-bottom: 13px; margin-right: 0px;"><span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);">As can be seen, JBOSS message cache was accumulating messages without purging them which resulted in a hooping 1.2GB cache. </span></p>
<p style="text-align: justify; margin-bottom: 13px; margin-right: 0px;">Questions welcomed,<span style="font-family: 'sans-serif','TT E 2 B 4 EC A 8t'; color: rgb(0, 0, 0);"><br />
</span></p>
