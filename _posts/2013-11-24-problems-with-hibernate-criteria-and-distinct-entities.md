---
layout: post
title: 'Problems with Hibernate Criteria and distinct entities '
created: 1385302685
author: andrew
permalink: /java/problems-hibernate-criteria-and-distinct-entities
tags:
- JAVA
- Hibernate
- java sql
- Hands-on Java
---
<p>I&#39;ve encountered a strange lack of ability in Hibernate Criteria API. Suppose you have an entity called User with many-to-many relationship to groups. If you need to find all users appearing in one or more of given groups, you can write an HQL like</p>

<pre class="code">
u from User u join u.groups g where g.id in :groups</pre>

<p>This query will do the job, but if a user appears in a few groups, it will appear few times in the result set. To fix that, we can use &quot;distinct&quot; keyword:</p>

<pre class="code">
distinct u from User u join u.groups g where g.id in :groups</pre>

<p>Unfortunately, I had to provide an ability to order the results by any property of User (first name, last name, etc), and support paging for showing only a few results out of thousands. HQL does not allow variables in &quot;order by&quot; clause, so I had to use Criteria for that.</p>

<p>Without the &quot;distinct&quot; the code is quite simple:</p>

<pre class="code">
Collection&lt;Long&gt; groups = ... //will come as a parameter
Order order = ... //will also come a parameter
int maxResults = ... //you&#39;ve got the idea

Criteria c = getSession().createCriteria(User.class);
c.createAlias(&quot;groups&quot;, &quot;g&quot;);
c.add(Restrictions.in(&quot;g.id&quot;, groups);
c.addOrder(o);
c.setMaxResults(maxResults);
return c.list();</pre>

<p>So far so good. Let us add distinct now. Criteria API has support for that. First I tried to add</p>

<pre class="code">
c.setProjection(Projections.distinct(Projections.id()))</pre>

<p>But the problem with this approach is it does not return a collection of User entities anymore, it returns a collection of Ids (integers). I tried to google a little bit for the solution, but found only complains on this missing feature.</p>

<p>So at the end I made up an inner query. I have to check yet what will be the performance degrade of this solution relative to the original HQL one, but at least it returns correct results:</p>

<pre class="code">
Collection&lt;Long&gt; groups = ... //will come as a parameter
Order order = ... //will also come a parameter
int maxResults = ... //you&#39;ve got the idea

DetachedCriteria dc = DetachedCriteria.forClass(User.class);
dc.createAlias(&quot;groups&quot;, &quot;g&quot;);
dc.add(Restrictions.in(&quot;g.id&quot;, groups);

Criteria c = getSession().createCriteria(User.class);
c.add(Property.forName(&quot;id&quot;).in(dc));
        
c.addOrder(o);
c.setMaxResults(maxResults);
return c.list();</pre>

<p>This criteria will create the following SQL (for brevity I shortened the aliases and replaced with the asterisk the long list of columns, generated by Hibernate:</p>

<pre class="“code”">
select this_.*
    from
        Users this_
    where
        this_.ID in (
            /* criteria query */ select
                distinct this_.ID 
            from
                Users this_
            join
              User_to_Group u2g
                on this_.ID=u2g.USER_ID
            join
              Groups gr
                on u2g.GROUP_ID=gr.ID
            where
              gr.ID in (
                ?,?
            )
        )
    order by
        this_.UserName</pre>

<p>One can see that in addition to SELECT IN SELECT, caused by the limitation of Criteria API I explained above, this query makes also unnecessary second because of many-to-many relationship. Ideally, I would like to get SQL like:</p>

<pre class="“code”">
select this_.*
    from
        Users this_
          join
            User_to_Group u2g
              on this_.ID=u2g.USER_ID
    where
        u2g.GROUP_ID in (
          ?,?
        )
    order by
        this_.UserName</pre>

<p>If you have suggestions how to improve my solution, please do not hesitate to comment. Thank you!</p>
